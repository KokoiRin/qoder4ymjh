# 组合模式（模块聚合设计）

<cite>
**Referenced Files in This Document**   
- [MainWindow.h](file://include/ui/MainWindow.h)
- [MainWindow.cpp](file://src/ui/MainWindow.cpp)
- [WindowManager.h](file://include/core/WindowManager.h)
- [ColorPicker.h](file://include/core/ColorPicker.h)
- [ClickSimulator.h](file://include/core/ClickSimulator.h)
- [WindowManager.cpp](file://src/core/WindowManager.cpp)
- [ColorPicker.cpp](file://src/core/ColorPicker.cpp)
- [ClickSimulator.cpp](file://src/core/ClickSimulator.cpp)
</cite>

## Table of Contents
1. [组合模式概述](#组合模式概述)
2. [核心模块聚合分析](#核心模块聚合分析)
3. [构造函数中的模块实例化](#构造函数中的模块实例化)
4. [组合模式的优势](#组合模式的优势)
5. [新增功能的集成示例](#新增功能的集成示例)
6. [类关系图](#类关系图)

## 组合模式概述

在本项目中，`MainWindow` 类通过成员变量 `windowManager`、`colorPicker` 和 `clickSimulator` 聚合了三个独立的核心功能模块，体现了典型的组合设计模式。这种设计将复杂的窗口操作功能分解为职责单一、高度内聚的独立对象，每个模块专注于特定领域的功能实现。

组合模式在此的应用使得 `MainWindow` 作为高层接口的统一提供者，无需关心各功能模块的具体实现细节，只需通过定义良好的接口与这些模块进行交互。这种分层架构不仅提高了代码的可读性和可维护性，还增强了系统的灵活性和扩展能力。

**Section sources**
- [MainWindow.h](file://include/ui/MainWindow.h#L23-L106)

## 核心模块聚合分析

`MainWindow` 类通过三个私有成员指针聚合了不同的功能模块：

- **`windowManager`**: 负责窗口枚举、绑定和状态管理
- **`colorPicker`**: 提供屏幕取色、颜色检测和实时更新功能
- **`clickSimulator`**: 实现鼠标点击模拟、坐标转换和窗口交互

这三个模块均继承自 `QObject`，遵循 Qt 的对象树管理机制，在 `MainWindow` 析构时会自动被清理。每个模块都封装了特定领域的复杂逻辑，如 `WindowManager` 封装了 Windows API 的窗口枚举和属性获取，`ColorPicker` 管理定时器驱动的颜色采样，而 `ClickSimulator` 处理不同坐标系之间的转换和鼠标事件注入。

这种聚合方式实现了关注点分离，使得每个模块可以独立开发、测试和优化，同时通过清晰的接口契约与主窗口进行协作。

**Section sources**
- [MainWindow.h](file://include/ui/MainWindow.h#L78-L80)
- [WindowManager.h](file://include/core/WindowManager.h#L22-L61)
- [ColorPicker.h](file://include/core/ColorPicker.h#L12-L56)
- [ClickSimulator.h](file://include/core/ClickSimulator.h#L27-L96)

## 构造函数中的模块实例化

在 `MainWindow` 的构造函数中，三个核心模块通过依赖注入的方式被实例化并设置父对象为 `this`：

```cpp
MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
    , windowManager(new WindowManager(this))
    , colorPicker(new ColorPicker(this))
    , clickSimulator(new ClickSimulator(this))
```

这种初始化方式具有多重优势：
1. **生命周期管理**：Qt 的父子对象机制确保了当 `MainWindow` 被销毁时，所有子对象会自动被清理
2. **内存安全**：避免了手动内存管理可能导致的泄漏或悬空指针问题
3. **依赖明确**：构造函数清晰地表达了 `MainWindow` 对这些模块的依赖关系
4. **可替换性**：为未来可能的依赖注入框架集成提供了基础

模块的实例化过程将创建逻辑集中于一处，保证了系统启动时各组件的正确初始化顺序和状态一致性。

**Section sources**
- [MainWindow.cpp](file://src/ui/MainWindow.cpp#L10-L17)

## 组合模式的优势

### 可测试性增强
由于功能模块被解耦为独立的类，可以针对 `WindowManager`、`ColorPicker` 和 `ClickSimulator` 分别编写单元测试，无需启动整个应用程序界面。例如，可以单独测试 `ColorPicker` 在不同屏幕坐标下的颜色获取准确性，或验证 `ClickSimulator` 的坐标转换算法正确性。

### 动态功能管理
组合模式支持运行时动态启停功能模块。如 `onStartColorPicker()` 槽函数所示，可以通过调用 `colorPicker->startPicking()` 和 `colorPicker->stopPicking()` 方法来控制取色功能的激活状态，而不会影响其他模块的正常运行。

### 配置灵活性
各模块提供了丰富的配置接口，如 `colorPicker->setUpdateInterval()` 可以调整取色频率，`clickSimulator->setClickDelay()` 可以设置点击延迟。这种设计允许用户根据具体需求微调各个功能的行为特征。

### 错误隔离
当某个模块出现故障时，错误影响范围被限制在该模块内部。例如，如果 `ClickSimulator` 因目标窗口失效而无法执行点击，它会通过信号通知主窗口，但不会导致整个应用程序崩溃。

**Section sources**
- [MainWindow.cpp](file://src/ui/MainWindow.cpp#L268-L282)
- [ColorPicker.cpp](file://src/core/ColorPicker.cpp#L28-L38)
- [ClickSimulator.cpp](file://src/core/ClickSimulator.cpp#L100-L105)

## 新增功能的集成示例

假设需要添加键盘模拟器功能，应遵循相同的组合模式进行集成：

1. **创建新模块类** `KeyboardSimulator`，继承自 `QObject`
2. **在 MainWindow.h 中声明成员变量**：
   ```cpp
   private:
       KeyboardSimulator* keyboardSimulator;
   ```

3. **在构造函数中实例化**：
   ```cpp
   MainWindow::MainWindow(QWidget *parent)
       : QMainWindow(parent)
       , keyboardSimulator(new KeyboardSimulator(this))
   ```

4. **连接信号槽**：
   ```cpp
   connect(keyboardButton, &QPushButton::clicked, this, &MainWindow::onSimulateKeystroke);
   connect(keyboardSimulator, &KeyboardSimulator::keystrokeExecuted, this, &MainWindow::onKeystrokeExecuted);
   ```

5. **实现业务逻辑**：
   ```cpp
   void MainWindow::onSimulateKeystroke() {
       if (keyboardSimulator->hasTargetWindow()) {
           keyboardSimulator->sendKey('A');
       }
   }
   ```

这种一致的设计模式确保了代码库的整体性和可维护性，新开发者可以快速理解并遵循既定的架构规范。

**Section sources**
- [MainWindow.h](file://include/ui/MainWindow.h#L78-L80)
- [MainWindow.cpp](file://src/ui/MainWindow.cpp#L10-L17)

## 类关系图

```mermaid
classDiagram
class MainWindow {
+MainWindow(QWidget* parent)
+~MainWindow()
-setupUI()
-connectSignals()
-updateWindowInfo()
-updateColorDisplay(QColor, QPoint)
-updateClickStatus(QString, bool)
-formatColorInfo(QColor, QPoint) QString
}
class WindowManager {
+WindowManager(QObject* parent)
+~WindowManager()
+refreshWindowList() void
+getWindowList() vector<WindowInfo>
+bindWindow(int) bool
+isBound() bool
+bringWindowToFront() bool
}
class ColorPicker {
+ColorPicker(QObject* parent)
+~ColorPicker()
+startPicking() void
+stopPicking() void
+getColorAt(QPoint) QColor
+setUpdateInterval(int) void
}
class ClickSimulator {
+ClickSimulator(QObject* parent)
+~ClickSimulator()
+click(QPoint, CoordinateType, MouseButton, ClickType) bool
+setTargetWindow(HWND) void
+bringWindowToFront() bool
}
MainWindow --> WindowManager : "聚合"
MainWindow --> ColorPicker : "聚合"
MainWindow --> ClickSimulator : "聚合"
note right of MainWindow
作为高层接口统一提供者
管理各模块的生命周期
协调模块间的交互
end note
note left of WindowManager
负责窗口枚举和绑定
封装Windows API调用
维护窗口列表状态
end note
note left of ColorPicker
提供实时取色功能
支持定时采样和手动捕获
发出颜色变化信号
end note
note right of ClickSimulator
模拟鼠标点击事件
支持多种坐标系转换
处理单击和双击操作
end note
```

**Diagram sources**
- [MainWindow.h](file://include/ui/MainWindow.h#L23-L106)
- [WindowManager.h](file://include/core/WindowManager.h#L22-L61)
- [ColorPicker.h](file://include/core/ColorPicker.h#L12-L56)
- [ClickSimulator.h](file://include/core/ClickSimulator.h#L27-L96)